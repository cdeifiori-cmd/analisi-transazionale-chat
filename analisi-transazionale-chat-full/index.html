<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisi Transazionale â€“ Chat</title>
  <style>
    :root { color-scheme: light; }
    html, body { margin:0; padding:0; background:#fff; font-family: system-ui, Arial, sans-serif; }
    #app { display:flex; flex-direction:column; height:100dvh; max-width:860px; margin:0 auto; }
    header { padding:12px 16px; border-bottom:1px solid #eee; }
    header h1 { margin:0; font-size:18px; }
    #messages { flex:1; overflow:auto; padding:16px; background:#fafafa; }
    .msg { display:flex; gap:10px; margin:10px 0; align-items:flex-start; }
    .msg.user { flex-direction:row-reverse; }
    .avatar {
      width:36px; height:36px; border-radius:50%; flex:0 0 36px;
      background:#ddd; display:grid; place-items:center; font-weight:700; font-size:12px;
    }
    .avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
    .bubble {
      max-width:80%;
      background:#e6f7e7; /* bot */
      border-radius:16px; padding:10px 12px; line-height:1.5;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      word-wrap:break-word;
    }
    .msg.user .bubble { background:#e8f0fe; }
    .meta { font-size:12px; color:#888; margin-top:4px; }
    .typing { display:inline-block; min-width:24px; }
    .dots::after { content:"â€¦"; animation: blink 1.2s infinite; }
    @keyframes blink { 0%, 60% {opacity:1;} 30%, 90% {opacity:.2;} }
    .input-row {
      display:flex; gap:8px; padding:10px; border-top:1px solid #eee; background:#fff;
      position:sticky; bottom:0;
    }
    .input-row input {
      flex:1; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px;
    }
    .input-row button {
      padding:12px 14px; border:0; border-radius:12px; background:#16a34a; color:#fff; font-weight:600; cursor:pointer;
    }
    .input-row button:disabled { opacity:.5; cursor:not-allowed; }
    .bubble strong{font-weight:700}
    .bubble em{font-style:italic}
    .disclaimer { font-size:12px; color:#666; padding:8px 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>Analisi Transazionale â€“ Conversa con lâ€™esperto</h1>
    </header>

    <div id="messages"></div>

    <div class="disclaimer">
      Questo strumento Ã¨ solo per allenamento/curiositÃ  e <strong>non sostituisce professionisti</strong>.
    </div>

    <div class="input-row">
      <input id="user-input" type="text" placeholder="Scrivi qui la tua domandaâ€¦" />
      <button id="send">Invia</button>
    </div>
  </div>

  <script>
    const API_URL = "/api/openai.php";

    const SYSTEM_PROMPT = `
Sei un esperto di Analisi Transazionale (Eric Berne), gruppoanalisi e dinamiche di gruppo.
Rispondi in modo sintetico, umano e leggibile, usando **grassetto**, *corsivo* e liste quando utile.
Dividi in punti chiave, collega sempre i concetti all'AT (Stati dell'Io, transazioni, giochi, copioni, carezze).
    `.trim();

    const elMessages = document.getElementById("messages");
    const elInput    = document.getElementById("user-input");
    const elSend     = document.getElementById("send");

    function addMessage(role, htmlOrText, {markdown=true} = {}) {
      const row = document.createElement("div");
      row.className = "msg " + (role === "user" ? "user" : "bot");

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = role === "user" ? "TU" : "AT";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = markdown ? marked.parse(htmlOrText) : htmlOrText;

      row.appendChild(avatar);
      row.appendChild(bubble);
      elMessages.appendChild(row);
      elMessages.scrollTop = elMessages.scrollHeight;

      return { row, bubble };
    }

    function addTyping() {
      return addMessage("bot", `<span class="typing">eric sta scrivendo<span class="dots"></span></span>`, {markdown:false});
    }

    async function typeIntoBubble(bubbleEl, fullText, speedMs=12) {
      let acc = "";
      for (let i=0; i<fullText.length; i++) {
        acc += fullText[i];
        bubbleEl.innerHTML = marked.parse(acc);
        elMessages.scrollTop = elMessages.scrollHeight;
        await new Promise(r => setTimeout(r, speedMs));
      }
    }

    async function send() {
      const text = elInput.value.trim();
      if (!text) return;
      elInput.value = "";
      elInput.focus();

      addMessage("user", text);
      const typing = addTyping();

      elSend.disabled = true;
      try {
        const payload = {
          messages: [
            { role: "system", content: SYSTEM_PROMPT },
            { role: "user",   content: text }
          ]
        };
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        typing.row.remove();

        if (!data.ok) throw new Error(data.error || "Errore API");
        const { bubble } = addMessage("bot", "");
        await typeIntoBubble(bubble, data.text, 10);
      } catch (err) {
        typing.row.remove();
        addMessage("bot", `**Ops.** Errore: ${err.message}`);
      } finally {
        elSend.disabled = false;
      }
    }

    elSend.addEventListener("click", send);
    elInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    addMessage("bot", `Ciao ðŸ‘‹ Scrivi un episodio o una frase e la analizziamo con l'AT.`);
  </script>
</body>
</html>